<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Decision Cards — What Are You Reading Today?</title>
  <style>
    .langToggle{
  position:fixed;
  top:16px;
  right:16px;
  background:#1a1c22;
  border:1px solid #333;
  border-radius:999px;
  padding:6px;
  display:flex;
  gap:6px;
  z-index:999;
}
.langToggle a{
  text-decoration:none;
  color:#eaeaf0;
  padding:6px 10px;
  border-radius:999px;
  font-size:13px;
}
.langToggle a.active{
  background:#333;
}
    :root{
      --bg:#0b0f14;--panel:#141b2d;--text:#e8eef7;--muted:#a9b6c7;
      --accent:#7aa2ff;--bad:#ff6b6b;--good:#4dffb0;--radius:16px;--shadow:0 12px 30px rgba(0,0,0,.35);
      --border:rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
        
    body{
      margin:0; min-height:100vh;
      font-family:ui-sans-serif,system-ui,-apple-system,"PingFang TC","Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 900px at 20% 10%, #14213a 0%, var(--bg) 55%) fixed;
      color:var(--text); display:flex; flex-direction:column; align-items:center;
    }
    header{width:min(1040px,94vw); padding:22px 8px 10px}
    h1{margin:0 0 6px; font-size:clamp(20px,4vw,30px)}
    .sub{color:var(--muted); margin:0; line-height:1.35; font-size:14px}
    .bar{
      width:min(1040px,94vw); margin:10px 0 12px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between
    }
    .left,.right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button, input[type="text"], input[type="number"]{
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(122,162,255,.22), rgba(122,162,255,.08));
      color:var(--text);
      padding:10px 14px; border-radius:999px; cursor:pointer;
      box-shadow:0 8px 22px rgba(0,0,0,.25);
      font-weight:800;
    }
    button:hover{border-color:rgba(122,162,255,.55)}
    button:disabled{opacity:.55; cursor:not-allowed}
    .ghost{background:transparent; border:1px solid rgba(255,255,255,.12); box-shadow:none}
    .danger{background:linear-gradient(180deg, rgba(255,107,107,.25), rgba(255,107,107,.10));}
    .pill{
      padding:8px 12px; border-radius:999px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
      color:var(--muted); font-size:13px; user-select:none
    }
    .pill strong{color:var(--text)}
    .panel{
      width:min(1040px,94vw);
      padding:12px 14px; border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(16,24,38,.80), rgba(16,24,38,.45));
      border:1px solid var(--border); box-shadow:var(--shadow);
      color:var(--muted); font-size:14px; line-height:1.5; margin-bottom:12px;
    }
    .panel b{color:var(--text)}
    .grid{
      width:min(1040px,94vw);
      display:grid; grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px; padding-bottom:26px
    }
    @media (max-width:920px){.grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media (max-width:560px){.grid{grid-template-columns:1fr;}}
    .card{
      padding:14px; border-radius:var(--radius);
      background:var(--panel); border:1px solid var(--border); box-shadow:var(--shadow);
    }
    .card h3{margin:0 0 6px; font-size:16px}
    .card p{margin:0; color:var(--muted); font-size:13px; line-height:1.35}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px}
    .small{font-size:12px; color:rgba(232,238,247,.60)}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.06);
      color:rgba(232,238,247,.75); font-size:12px; margin-right:6px; margin-top:6px
    }
    .pick{
      width:min(1040px,94vw);
      padding:14px; border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(16,24,38,.92), rgba(14,21,33,.82));
      border:1px solid var(--border); box-shadow:var(--shadow);
      margin-bottom:12px; display:none
    }
    .pick.show{display:block}
    .bookTitle{font-size:18px; font-weight:900; margin:0 0 6px}
    .meta{color:var(--muted); font-size:13px; margin:0}
    .checkRow{display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap}
    .checkRow input{width:18px; height:18px}
    footer{
      width:min(1040px,94vw);
      color:rgba(232,238,247,.55); font-size:12px; padding:0 8px 26px
    }
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px}
    .backdrop.show{display:flex}
    .modal{
      width:min(980px,96vw); max-height:88vh; overflow:auto;
      background:linear-gradient(180deg, rgba(16,24,38,.98), rgba(14,21,33,.95));
      border:1px solid rgba(255,255,255,.14);
      border-radius:20px; box-shadow:0 18px 50px rgba(0,0,0,.55);
      padding:16px;
    }
    .modal h2{margin:0 0 8px; font-size:18px}
    .modal .hint{margin:0 0 14px; color:rgba(232,238,247,.70); font-size:13px; line-height:1.4}
    .field{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px}
    .field label{display:flex; align-items:center; justify-content:space-between; gap:10px; font-size:13px; color:rgba(232,238,247,.75); margin-bottom:8px}
    .field input[type="text"], .field input[type="number"]{
      width:100%; border-radius:12px; padding:10px 12px; font-weight:700;
      background:rgba(255,255,255,.05); box-shadow:none; border:1px solid rgba(255,255,255,.12); cursor:text;
    }
    .minirow{display:flex; gap:10px; flex-wrap:wrap}
    .minirow .field{flex:1; min-width:180px}
    .divider{height:1px; background:rgba(255,255,255,.10); margin:12px 0}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .progressbar{
      width:100%; height:10px; background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10); border-radius:999px; overflow:hidden;
      margin-top:8px;
    }
    .progressbar > div{
      height:100%; width:0%;
      background:linear-gradient(90deg, rgba(122,162,255,.9), rgba(77,255,176,.85));
      transition:width .15s ease;
    }
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; padding:2px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06); color:rgba(232,238,247,.8);
    }
  </style>
</head>
<body>
<div class="langToggle">
  <a href="index.html" class="active">中文</a>
  <a href="index-en.html">EN</a>
</div>
  
  
<header>
  <h1>Decision Cards（All‑in‑One・零後端）</h1>
  <p class="sub">
    上傳 Goodreads CSV（to-read）→ 自動查 <b>Open Library</b> 補 subjects → 用 category 規則抽書。<br>
    每個人資料都在自己的裝置（localStorage）；放 GitHub Pages 丟網址就能給朋友用。
  </p>
</header>

<div class="bar">
  <div class="left">
    <span class="pill" id="libPill"><strong>Library:</strong> 0 books</span>
    <span class="pill" id="confirmPill"><strong>Today Confirmed:</strong> 0 / 2</span>
    <span class="pill" id="coolPill"><strong>Cooldown:</strong> 30 days</span>
  </div>
  <div class="right">
    <button id="uploadBtn">Upload Goodreads CSV</button>
    <input id="fileInput" type="file" accept=".csv,text/csv" style="display:none" />
    <button id="enrichBtn" class="ghost">Enrich subjects</button>
    <button id="catsBtn" class="ghost">Edit categories</button>
    <button id="settingsBtn" class="ghost">Options</button>
    <button id="backupBtn" class="ghost">Backup JSON</button>
    <button id="restoreBtn" class="ghost">Restore JSON</button>
    <input id="restoreInput" type="file" accept=".json,application/json" style="display:none" />
    <button id="wipeBtn" class="danger ghost">Wipe my data</button>
  </div>
</div>

<div class="panel">
  <b>用法：</b>
  1) 按 <b>Upload Goodreads CSV</b>（只讀 <span class="kbd">Exclusive Shelf = to-read</span>）。
  2) 第一次會自動補 subjects（進度條會跑）。
  3) 點分類 <b>Open</b> 看候選；真正要讀的那本勾選 <b>I chose this</b> 再按 <b>Confirm</b>（每日最多 1–2 本）。<br>
  <span class="small">提示：點開不等於選定；未 Confirm 的候選未來仍可能再抽到。</span>
  <div class="progressbar" id="pb" style="display:none"><div id="pbFill"></div></div>
  <div class="small" id="pbText" style="margin-top:6px; display:none"></div>
</div>

<div class="pick" id="pickBox">
  <div class="small" id="pickLabel">—</div>
  <p class="bookTitle" id="pickTitle">—</p>
  <p class="meta" id="pickMeta">—</p>
  <div id="pickTags"></div>
  <div class="checkRow">
    <label style="display:flex;gap:8px;align-items:center;">
      <input type="checkbox" id="chooseChk">
      <span><b>I chose this</b>（我最後選了這本）</span>
    </label>
    <button id="confirmBtn" disabled>Confirm</button>
    <button id="dismissBtn" class="ghost">Close</button>
    <span class="small" id="confirmHint">未 Confirm 的候選不會被排除，之後仍可再抽到。</span>
  </div>
</div>

<div class="grid" id="cats"></div>

<footer>
  <div>零後端：放在 GitHub Pages → 朋友打開同一個網址 → 上傳自己的 Goodreads CSV → 立刻能用。</div>
</footer>

<!-- Category Editor Modal -->
<div class="backdrop" id="catsModal">
  <div class="modal">
    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div>
        <h2>Categories（最多 10 個）</h2>
        <p class="hint">輕量規則：subjects/title/author 關鍵字 + pages/year 範圍。建議 subjects 當主力（Open Library）。</p>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="addCatBtn">Add category</button>
        <button id="closeCatsBtn" class="ghost">Close</button>
      </div>
    </div>
    <div class="divider"></div>
    <div id="catsEditor"></div>
    <div class="divider"></div>
    <div class="row" style="justify-content:flex-end">
      <button id="saveCatsBtn">Save</button>
    </div>
  </div>
</div>

<!-- Options Modal -->
<div class="backdrop" id="settingsModal">
  <div class="modal">
    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div>
        <h2>Options</h2>
        <p class="hint">每日 Confirm 上限（1–2）＋ Cooldown 天數（0–365）。</p>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="closeSettingsBtn" class="ghost">Close</button>
      </div>
    </div>
    <div class="divider"></div>
    <div class="minirow">
      <div class="field">
        <label>Daily Confirm Limit（1–2）</label>
        <input type="number" id="setDaily" min="1" max="2" step="1" />
      </div>
      <div class="field">
        <label>Cooldown Days（0–365）</label>
        <input type="number" id="setCooldown" min="0" max="365" step="1" />
      </div>
    </div>
    <div class="divider"></div>
    <div class="row" style="justify-content:flex-end">
      <button id="saveSettingsBtn">Save</button>
    </div>
  </div>
</div>

<script>
(() => {
  const KEY_BOOKS = "dc_books_allinone_v1";
  const KEY_CATS  = "dc_categories_allinone_v1";
  const KEY_DRAWS = "dc_daily_draws_allinone_v1";
  const KEY_CONF  = "dc_confirmations_allinone_v1";
  const KEY_SET   = "dc_settings_allinone_v1";

  const libPill = document.getElementById("libPill");
  const confirmPill = document.getElementById("confirmPill");
  const coolPill = document.getElementById("coolPill");

  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");
  const enrichBtn = document.getElementById("enrichBtn");
  const catsBtn = document.getElementById("catsBtn");
  const settingsBtn = document.getElementById("settingsBtn");
  const backupBtn = document.getElementById("backupBtn");
  const restoreBtn = document.getElementById("restoreBtn");
  const restoreInput = document.getElementById("restoreInput");
  const wipeBtn = document.getElementById("wipeBtn");

  const pb = document.getElementById("pb");
  const pbFill = document.getElementById("pbFill");
  const pbText = document.getElementById("pbText");

  const catsEl = document.getElementById("cats");
  const pickBox = document.getElementById("pickBox");
  const pickLabel = document.getElementById("pickLabel");
  const pickTitle = document.getElementById("pickTitle");
  const pickMeta = document.getElementById("pickMeta");
  const pickTags = document.getElementById("pickTags");
  const chooseChk = document.getElementById("chooseChk");
  const confirmBtn = document.getElementById("confirmBtn");
  const dismissBtn = document.getElementById("dismissBtn");
  const confirmHint = document.getElementById("confirmHint");

  const catsModal = document.getElementById("catsModal");
  const catsEditor = document.getElementById("catsEditor");
  const addCatBtn = document.getElementById("addCatBtn");
  const closeCatsBtn = document.getElementById("closeCatsBtn");
  const saveCatsBtn = document.getElementById("saveCatsBtn");

  const settingsModal = document.getElementById("settingsModal");
  const closeSettingsBtn = document.getElementById("closeSettingsBtn");
  const saveSettingsBtn = document.getElementById("saveSettingsBtn");
  const setDaily = document.getElementById("setDaily");
  const setCooldown = document.getElementById("setCooldown");

  const pad = (n) => String(n).padStart(2,"0");
  const today = () => {
    const d=new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };
  const nowYear = () => new Date().getFullYear();

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    }catch(e){ return fallback; }
  }
  function saveJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }
  function normalizeStr(s){
    return (s||"").toString().trim().toLowerCase().replace(/\s+/g," ");
  }
  function makeBookId(title, author){
    return normalizeStr(title) + "|" + normalizeStr(author);
  }
  function numOrNull(x){
    const n = Number(String(x||"").trim());
    return Number.isFinite(n) ? n : null;
  }
  function uniq(arr){ return Array.from(new Set((arr||[]).filter(Boolean))); }

  function parseCSV(text){
    const rows=[];
    let i=0, field="", row=[], inQuotes=false;
    while(i<text.length){
      const ch=text[i];
      if(inQuotes){
        if(ch === '"'){
          if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
          inQuotes=false; i++; continue;
        }
        field+=ch; i++; continue;
      }else{
        if(ch === '"'){ inQuotes=true; i++; continue; }
        if(ch === ','){ row.push(field); field=""; i++; continue; }
        if(ch === '\r'){ i++; continue; }
        if(ch === '\n'){ row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
        field+=ch; i++; continue;
      }
    }
    if(field.length || row.length){ row.push(field); rows.push(row); }
    return rows;
  }

  function getSettings(){
    const s = loadJSON(KEY_SET, {cooldownDays:30, dailyConfirmLimit:2});
    s.dailyConfirmLimit = Math.max(1, Math.min(2, Number(s.dailyConfirmLimit||2)));
    s.cooldownDays = Math.max(0, Math.min(365, Number(s.cooldownDays||30)));
    return s;
  }
  function setSettings(s){
    s.dailyConfirmLimit = Math.max(1, Math.min(2, Number(s.dailyConfirmLimit||2)));
    s.cooldownDays = Math.max(0, Math.min(365, Number(s.cooldownDays||30)));
    saveJSON(KEY_SET, s);
  }

  function defaultCategories(){
    const y = nowYear();
    return [
      {id:"crime_mystery", name:"Crime & Mystery", enabled:true, system:true, rules:{subjects:["crime","mystery","detective","murder","thriller"], title:[], author:[], pagesMin:null, pagesMax:null, yearMin:null, yearMax:null}},
      {id:"sci_fi", name:"Science Fiction", enabled:true, system:true, rules:{subjects:["science fiction","space","dystopia","time travel","space opera"], title:[], author:[], pagesMin:null, pagesMax:null, yearMin:null, yearMax:null}},
      {id:"nonfiction", name:"Non-fiction", enabled:true, system:true, rules:{subjects:["history","biography","memoir","science","essays","nonfiction"], title:[], author:[], pagesMin:null, pagesMax:null, yearMin:null, yearMax:null}},
      {id:"short_read", name:"Short Read (≤200 pages)", enabled:true, system:true, rules:{subjects:[], title:[], author:[], pagesMin:null, pagesMax:200, yearMin:null, yearMax:null}},
      {id:"timeless_classic", name:"Timeless Classic (≥20 years)", enabled:true, system:true, rules:{subjects:[], title:[], author:[], pagesMin:null, pagesMax:null, yearMin:null, yearMax:(y-20)}},
      {id:"wildcard", name:"Surprise Me / Wildcard", enabled:true, system:true, rules:{subjects:[], title:[], author:[], pagesMin:null, pagesMax:null, yearMin:null, yearMax:null, wildcard:true}},
    ];
  }

  function getCategories(){
    let cats = loadJSON(KEY_CATS, null);
    if(!cats || !Array.isArray(cats) || cats.length===0){
      cats = defaultCategories();
      saveJSON(KEY_CATS, cats);
    }
    if(cats.length > 10){
      cats = cats.slice(0,10);
      saveJSON(KEY_CATS, cats);
    }
    return cats;
  }
  function setCategories(cats){
    if(cats.length > 10) cats = cats.slice(0,10);
    saveJSON(KEY_CATS, cats);
  }

  function getBooks(){ return loadJSON(KEY_BOOKS, []); }
  function setBooks(books){ saveJSON(KEY_BOOKS, books); }

  function confirmations(){ return loadJSON(KEY_CONF, []); }
  function setConfirmations(arr){ saveJSON(KEY_CONF, arr); }

  function dailyDraws(){ return loadJSON(KEY_DRAWS, {}); }
  function setDailyDraws(obj){ saveJSON(KEY_DRAWS, obj); }

  function countConfirmedToday(){
    const t = today();
    return confirmations().filter(x => x.date === t).length;
  }

  function inCooldown(bookId){
    const s = getSettings();
    const cd = Number(s.cooldownDays||0);
    if(cd<=0) return false;
    const t0 = new Date(today()+"T00:00:00");
    const conf = confirmations().filter(x => x.bookId === bookId);
    if(conf.length===0) return false;
    const last = conf.map(x => new Date(x.date+"T00:00:00")).sort((a,b)=>b-a)[0];
    const diffDays = Math.floor((t0 - last) / (1000*60*60*24));
    return diffDays >= 0 && diffDays < cd;
  }

  function basePool(){
    const books = getBooks();
    return books.filter(b => (b.status||"active")==="active" && !inCooldown(b.id));
  }

  function matchesRules(book, cat){
    const r = cat.rules || {};
    if(r.wildcard) return true;

    if(r.subjects && r.subjects.length){
      const subs = (book.subjects||[]).map(s=>String(s).toLowerCase());
      const keys = r.subjects.map(s=>String(s).toLowerCase()).filter(Boolean);
      const hit = keys.some(k => subs.some(s => s.includes(k)));
      if(!hit) return false;
    }
    if(r.title && r.title.length){
      const t = normalizeStr(book.title);
      const keys = r.title.map(normalizeStr).filter(Boolean);
      const hit = keys.some(k => t.includes(k));
      if(!hit) return false;
    }
    if(r.author && r.author.length){
      const a = normalizeStr(book.author);
      const keys = r.author.map(normalizeStr).filter(Boolean);
      const hit = keys.some(k => a.includes(k));
      if(!hit) return false;
    }
    if(r.pagesMin !== null && r.pagesMin !== "" && book.pages !== null){
      if(Number(book.pages) < Number(r.pagesMin)) return false;
    }
    if(r.pagesMax !== null && r.pagesMax !== "" && book.pages !== null){
      if(Number(book.pages) > Number(r.pagesMax)) return false;
    }
    if(r.yearMin !== null && r.yearMin !== "" && book.year !== null){
      if(Number(book.year) < Number(r.yearMin)) return false;
    }
    if(r.yearMax !== null && r.yearMax !== "" && book.year !== null){
      if(Number(book.year) > Number(r.yearMax)) return false;
    }
    return true;
  }

  function poolForCat(cat){
    if(!cat.enabled) return [];
    const pool = basePool();
    return pool.filter(b => matchesRules(b, cat));
  }

  function pickOne(arr){
    if(!arr.length) return null;
    return arr[Math.floor(Math.random()*arr.length)];
  }

  function showProgress(show, pct=0, text=""){
    pb.style.display = show ? "block" : "none";
    pbText.style.display = show ? "block" : "none";
    pbFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    pbText.textContent = text || "";
  }

  async function fetchSubjectsForBook(book){
    const isbn = (book.isbn13 || book.isbn || "").replace(/[^0-9Xx]/g,"").trim();
    let url = "";
    if(isbn){
      url = `https://openlibrary.org/search.json?isbn=${encodeURIComponent(isbn)}&limit=1`;
    }else{
      const q = `${book.title} ${book.author}`.trim();
      url = `https://openlibrary.org/search.json?q=${encodeURIComponent(q)}&limit=1`;
    }
    try{
      const res = await fetch(url);
      if(!res.ok) return [];
      const data = await res.json();
      if(data && data.docs && data.docs.length){
        const doc = data.docs[0];
        const subj = doc.subject || [];
        return uniq(subj.map(s => String(s).trim()).filter(Boolean)).slice(0,12);
      }
    }catch(e){}
    return [];
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function enrichAllSubjects(force=false){
    const books = getBooks();
    if(!books.length){
      alert("還沒有書庫。請先 Upload Goodreads CSV。");
      return;
    }
    const targets = books.filter(b => force ? true : !((b.subjects||[]).length));
    if(!targets.length){
      alert("目前每本書都已有 subjects（或至少不為空）。");
      return;
    }
    showProgress(true, 0, `Enriching subjects… 0/${targets.length}`);
    for(let i=0;i<targets.length;i++){
      const b = targets[i];
      const subs = await fetchSubjectsForBook(b);
      b.subjects = uniq([...(b.subjects||[]), ...subs]);
      const pct = Math.round(((i+1)/targets.length)*100);
      showProgress(true, pct, `Enriching subjects… ${i+1}/${targets.length}`);
      await sleep(120);
    }
    setBooks(books);
    showProgress(false);
    refreshPills();
    renderCats();
    alert("subjects 補齊完成（命中率取決於 Open Library 是否收錄）。");
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function refreshPills(){
    const books = getBooks();
    libPill.innerHTML = `<strong>Library:</strong> ${books.length} books`;
    const s = getSettings();
    coolPill.innerHTML = `<strong>Cooldown:</strong> ${s.cooldownDays} days`;
    const c = countConfirmedToday();
    confirmPill.innerHTML = `<strong>Today Confirmed:</strong> ${c} / ${s.dailyConfirmLimit}`;
  }

  function renderCats(){
    const cats = getCategories();
    const draws = dailyDraws();
    const t = today();
    const todayDraw = draws[t] || {};
    catsEl.innerHTML = "";

    cats.forEach(cat => {
      const box = document.createElement("div");
      box.className = "card";

      const pickedToday = Boolean(todayDraw[cat.id]);
      const hint = pickedToday ? "（今日已抽）" : "（今日未抽）";
      const enabledTag = cat.enabled ? `<span class="tag">Enabled</span>` : `<span class="tag" style="border-color:rgba(255,107,107,.35);color:rgba(255,255,255,.75)">Disabled</span>`;

      const r = cat.rules || {};
      const parts=[];
      if(r.wildcard) parts.push("any");
      if(r.subjects && r.subjects.length) parts.push(`subjects: ${r.subjects.slice(0,4).join(", ")}${r.subjects.length>4?"…":""}`);
      if(r.title && r.title.length) parts.push(`title: ${r.title.slice(0,3).join(", ")}${r.title.length>3?"…":""}`);
      if(r.author && r.author.length) parts.push(`author: ${r.author.slice(0,3).join(", ")}${r.author.length>3?"…":""}`);
      if(r.pagesMin!==null && r.pagesMin!=="") parts.push(`pages ≥ ${r.pagesMin}`);
      if(r.pagesMax!==null && r.pagesMax!=="") parts.push(`pages ≤ ${r.pagesMax}`);
      if(r.yearMin!==null && r.yearMin!=="") parts.push(`year ≥ ${r.yearMin}`);
      if(r.yearMax!==null && r.yearMax!=="") parts.push(`year ≤ ${r.yearMax}`);
      const summary = parts.length ? parts.join(" · ") : "no rule";

      box.innerHTML = `
        <h3>${escapeHtml(cat.name)} <span class="small">${hint}</span></h3>
        <p>${escapeHtml(summary)}</p>
        <div class="row">
          ${enabledTag}
          <button data-open="${cat.id}" ${cat.enabled?"":"disabled"}>${pickedToday ? "View" : "Draw"}</button>
        </div>
      `;
      box.querySelector("button[data-open]").addEventListener("click", () => openPick(cat.id));
      catsEl.appendChild(box);
    });
  }

  let currentPick = null;

  function openPick(catId){
    const cats = getCategories();
    const cat = cats.find(c => c.id === catId);
    if(!cat || !cat.enabled){
      alert("這個 category 目前是關閉的。請到 Edit categories 開啟。");
      return;
    }
    const books = getBooks();
    if(books.length === 0){
      alert("你還沒有匯入書單。請先 Upload Goodreads CSV。");
      return;
    }

    const t = today();
    const draws = dailyDraws();
    draws[t] = draws[t] || {};
    let bookId = draws[t][catId] || "";
    let book = null;

    if(bookId){
      book = books.find(b => b.id === bookId) || null;
      // 「每個 category 每天只能抽一次」：如果今天已抽過，就不再重抽（即使該書後來進入 cooldown）
      if(!book){
        alert("今天這個 category 已抽過，但書庫找不到那本書（可能被清掉/重置）。請明天再抽。");
        return;
      }
      if(inCooldown(book.id)){
        alert("今天這個 category 已抽過，但這本書已因 Confirm 進入 cooldown。依規則不重抽；請明天再抽。");
        return;
      }
    }

    if(!book){
      let pool = poolForCat(cat);
      if(pool.length === 0) pool = basePool();
      book = pickOne(pool);
      if(!book){
        alert("沒有可抽的書（可能全部都在 cooldown 或不是 active）。");
        return;
      }
      draws[t][catId] = book.id;
      setDailyDraws(draws);
    }

    currentPick = {catId, book};
    pickLabel.textContent = `${t} · ${cat.name}`;
    pickTitle.textContent = book.title || "—";
    const meta = [];
    if(book.author) meta.push(book.author);
    if(book.pages !== null && book.pages !== undefined) meta.push(`${book.pages} pages`);
    if(book.year !== null && book.year !== undefined) meta.push(`${book.year}`);
    pickMeta.textContent = meta.length ? meta.join(" · ") : "—";

    pickTags.innerHTML = "";
    const subs = (book.subjects||[]);
    if(subs.length){
      subs.slice(0,14).forEach(s => {
        const el = document.createElement("span");
        el.className = "tag";
        el.textContent = s;
        pickTags.appendChild(el);
      });
    }else{
      const el = document.createElement("span");
      el.className = "tag";
      el.style.borderColor = "rgba(255,107,107,.35)";
      el.textContent = "no subjects (try Enrich)";
      pickTags.appendChild(el);
    }

    chooseChk.checked = false;
    confirmBtn.disabled = true;

    const s = getSettings();
    const c = countConfirmedToday();
    if(c >= s.dailyConfirmLimit){
      confirmHint.textContent = `今日已 Confirm ${c}/${s.dailyConfirmLimit}（已達上限）。你仍可看候選，但不能再 Confirm。`;
    }else{
      confirmHint.textContent = "未 Confirm 的候選不會被排除，之後仍可再抽到。";
    }

    pickBox.classList.add("show");
    pickBox.scrollIntoView({behavior:"smooth", block:"center"});
    renderCats();
    refreshPills();
  }

  chooseChk.addEventListener("change", () => {
    const s = getSettings();
    const c = countConfirmedToday();
    confirmBtn.disabled = !(chooseChk.checked && c < s.dailyConfirmLimit);
  });

  confirmBtn.addEventListener("click", () => {
    if(!currentPick) return;
    const s = getSettings();
    const c = countConfirmedToday();
    if(c >= s.dailyConfirmLimit){
      alert("今天已達 Confirm 上限。");
      confirmBtn.disabled = true;
      return;
    }
    const t = today();
    const arr = confirmations();
    arr.push({date:t, bookId: currentPick.book.id, catId: currentPick.catId});
    setConfirmations(arr);
    alert("已 Confirm。這本書會進入 cooldown。");
    pickBox.classList.remove("show");
    currentPick = null;
    refreshPills();
    renderCats();
  });

  dismissBtn.addEventListener("click", () => {
    pickBox.classList.remove("show");
    currentPick = null;
  });

  // Upload
  uploadBtn.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", async () => {
    const f = fileInput.files && fileInput.files[0];
    if(!f) return;
    try{
      const text = await f.text();
      const rows = parseCSV(text);
      if(rows.length < 2) throw new Error("CSV 空或格式不對");

      const header = rows[0].map(h => (h||"").trim());
      const idx = (name) => header.indexOf(name);

      const iTitle = idx("Title");
      const iAuthor = idx("Author");
      const iShelf = idx("Exclusive Shelf");
      const iPages = idx("Number of Pages");
      const iYear  = idx("Year Published");
      const iISBN13 = idx("ISBN13");
      const iISBN = idx("ISBN");

      if(iTitle === -1 || iAuthor === -1 || iShelf === -1){
        throw new Error("這看起來不是 Goodreads Export（缺 Title/Author/Exclusive Shelf 欄位）");
      }

      const incoming = [];
      for(let r=1; r<rows.length; r++){
        const row = rows[r] || [];
        const shelf = (row[iShelf]||"").trim().toLowerCase();
        if(shelf !== "to-read") continue;

        const title = (row[iTitle]||"").trim();
        const author = (row[iAuthor]||"").trim();
        if(!title) continue;

        const pages = iPages !== -1 ? numOrNull(row[iPages]) : null;
        const year  = iYear  !== -1 ? numOrNull(row[iYear])  : null;
        const isbn13 = (iISBN13 !== -1 ? (row[iISBN13]||"") : "").trim();
        const isbn = (iISBN !== -1 ? (row[iISBN]||"") : "").trim();

        const id = makeBookId(title, author);
        incoming.push({id,title,author,pages,year,isbn13,isbn,subjects:[],status:"active"});
      }

      if(incoming.length === 0){
        alert("沒有讀到 shelf=to-read 的書。");
        return;
      }

      const existing = getBooks();
      const map = new Map(existing.map(b => [b.id, b]));
      incoming.forEach(b => {
        const prev = map.get(b.id);
        if(prev){
          prev.pages = prev.pages ?? b.pages;
          prev.year  = prev.year  ?? b.year;
          prev.isbn13 = prev.isbn13 || b.isbn13;
          prev.isbn  = prev.isbn  || b.isbn;
          prev.title = prev.title || b.title;
          prev.author = prev.author || b.author;
          prev.status = prev.status || "active";
          prev.subjects = uniq(prev.subjects || []);
          map.set(prev.id, prev);
        }else{
          map.set(b.id, b);
        }
      });

      const merged = Array.from(map.values());
      setBooks(merged);
      getSettings(); getCategories();

      alert(`匯入完成：to-read 共 ${incoming.length} 本（合併後書庫 ${merged.length} 本）。接下來會自動補 subjects。`);

      refreshPills();
      renderCats();
      await enrichAllSubjects(false);

    }catch(e){
      alert("匯入失敗：" + (e.message || e));
    }finally{
      fileInput.value = "";
    }
  });

  enrichBtn.addEventListener("click", async () => {
    const force = confirm("要強制重新補 subjects（全部書重新查 Open Library）嗎？\n按「取消」= 只補缺 subjects 的書。");
    await enrichAllSubjects(force);
  });

  // Category editor
  function splitKeywords(s){ return (s||"").split(",").map(x => x.trim()).filter(Boolean); }

  catsBtn.addEventListener("click", () => {
    renderCatsEditor();
    catsModal.classList.add("show");
  });
  closeCatsBtn.addEventListener("click", () => catsModal.classList.remove("show"));
  catsModal.addEventListener("click", (e) => { if(e.target === catsModal) catsModal.classList.remove("show"); });

  addCatBtn.addEventListener("click", () => {
    const cats = getCategories();
    if(cats.length >= 10){ alert("最多 10 個 category。"); return; }
    const id = "cat_" + Math.random().toString(16).slice(2,10);
    cats.push({id, name:"New Category", enabled:true, system:false, rules:{subjects:[], title:[], author:[], pagesMin:null, pagesMax:null, yearMin:null, yearMax:null}});
    setCategories(cats);
    renderCatsEditor();
  });

  function renderCatsEditor(){
    const cats = getCategories();
    catsEditor.innerHTML = "";
    cats.forEach(cat => {
      const r = cat.rules || {};
      const wrap = document.createElement("div");
      wrap.className = "field";
      wrap.style.marginBottom = "12px";
      const delBtn = (!cat.system) ? `<button class="ghost danger" data-del="${cat.id}">Delete</button>` : ``;

      wrap.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <label style="margin:0">Name</label>
            <input type="text" data-name="${cat.id}" value="${escapeHtml(cat.name)}" style="width:min(520px,70vw)" />
            <label style="margin:0;display:flex;gap:8px;align-items:center;">
              <input type="checkbox" data-enabled="${cat.id}" ${cat.enabled?"checked":""} />
              Enabled
            </label>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            ${cat.system ? `<span class="tag">System</span>` : `<span class="tag">Custom</span>`}
            ${delBtn}
          </div>
        </div>
        <div class="minirow" style="margin-top:10px">
          <div class="field">
            <label>Subjects keywords（逗號分隔）</label>
            <input type="text" data-sub="${cat.id}" value="${escapeHtml((r.subjects||[]).join(", "))}" />
          </div>
          <div class="field">
            <label>Title keywords（逗號分隔）</label>
            <input type="text" data-title="${cat.id}" value="${escapeHtml((r.title||[]).join(", "))}" />
          </div>
          <div class="field">
            <label>Author keywords（逗號分隔）</label>
            <input type="text" data-author="${cat.id}" value="${escapeHtml((r.author||[]).join(", "))}" />
          </div>
        </div>
        <div class="minirow" style="margin-top:10px">
          <div class="field"><label>Pages min</label><input type="number" data-pmin="${cat.id}" value="${r.pagesMin ?? ""}" /></div>
          <div class="field"><label>Pages max</label><input type="number" data-pmax="${cat.id}" value="${r.pagesMax ?? ""}" /></div>
          <div class="field"><label>Year min</label><input type="number" data-ymin="${cat.id}" value="${r.yearMin ?? ""}" /></div>
          <div class="field"><label>Year max</label><input type="number" data-ymax="${cat.id}" value="${r.yearMax ?? ""}" /></div>
        </div>
      `;
      catsEditor.appendChild(wrap);
    });

    catsEditor.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        const cats = getCategories();
        const next = cats.filter(c => c.id !== id);
        setCategories(next);
        renderCatsEditor();
      });
    });
  }

  saveCatsBtn.addEventListener("click", () => {
    const cats = getCategories();
    cats.forEach(cat => {
      const nameEl = catsEditor.querySelector(`input[data-name="${cat.id}"]`);
      const enEl   = catsEditor.querySelector(`input[data-enabled="${cat.id}"]`);
      const subEl  = catsEditor.querySelector(`input[data-sub="${cat.id}"]`);
      const tEl    = catsEditor.querySelector(`input[data-title="${cat.id}"]`);
      const aEl    = catsEditor.querySelector(`input[data-author="${cat.id}"]`);
      const pminEl = catsEditor.querySelector(`input[data-pmin="${cat.id}"]`);
      const pmaxEl = catsEditor.querySelector(`input[data-pmax="${cat.id}"]`);
      const yminEl = catsEditor.querySelector(`input[data-ymin="${cat.id}"]`);
      const ymaxEl = catsEditor.querySelector(`input[data-ymax="${cat.id}"]`);

      cat.name = (nameEl ? nameEl.value.trim() : cat.name) || cat.name;
      cat.enabled = !!(enEl && enEl.checked);

      const r = cat.rules || {};
      r.subjects = splitKeywords(subEl ? subEl.value : "");
      r.title    = splitKeywords(tEl ? tEl.value : "");
      r.author   = splitKeywords(aEl ? aEl.value : "");
      r.pagesMin = pminEl && pminEl.value !== "" ? Number(pminEl.value) : null;
      r.pagesMax = pmaxEl && pmaxEl.value !== "" ? Number(pmaxEl.value) : null;
      r.yearMin  = yminEl && yminEl.value !== "" ? Number(yminEl.value) : null;
      r.yearMax  = ymaxEl && ymaxEl.value !== "" ? Number(ymaxEl.value) : null;
      cat.rules = r;
    });

    setCategories(cats);
    catsModal.classList.remove("show");
    renderCats();
  });

  // Options
  settingsBtn.addEventListener("click", () => {
    const s = getSettings();
    setDaily.value = s.dailyConfirmLimit;
    setCooldown.value = s.cooldownDays;
    settingsModal.classList.add("show");
  });
  closeSettingsBtn.addEventListener("click", () => settingsModal.classList.remove("show"));
  settingsModal.addEventListener("click", (e) => { if(e.target === settingsModal) settingsModal.classList.remove("show"); });
  saveSettingsBtn.addEventListener("click", () => {
    const s = getSettings();
    s.dailyConfirmLimit = Number(setDaily.value || s.dailyConfirmLimit);
    s.cooldownDays = Number(setCooldown.value || s.cooldownDays);
    setSettings(s);
    settingsModal.classList.remove("show");
    refreshPills();
    renderCats();
  });

  // Backup/Restore
  backupBtn.addEventListener("click", () => {
    const payload = {
      version: "all-in-one-v1",
      exportedAt: new Date().toISOString(),
      books: getBooks(),
      categories: getCategories(),
      dailyDraws: dailyDraws(),
      confirmations: confirmations(),
      settings: getSettings()
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "decision_cards_backup.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  restoreBtn.addEventListener("click", () => restoreInput.click());
  restoreInput.addEventListener("change", async () => {
    const f = restoreInput.files && restoreInput.files[0];
    if(!f) return;
    try{
      const text = await f.text();
      const payload = JSON.parse(text);
      if(!payload || !payload.version) throw new Error("備份檔格式不對");
      if(payload.books) setBooks(payload.books);
      if(payload.categories) setCategories(payload.categories);
      if(payload.dailyDraws) setDailyDraws(payload.dailyDraws);
      if(payload.confirmations) setConfirmations(payload.confirmations);
      if(payload.settings) setSettings(payload.settings);

      alert("Restore 完成。");
      refreshPills();
      renderCats();
    }catch(e){
      alert("Restore 失敗：" + (e.message || e));
    }finally{
      restoreInput.value = "";
    }
  });

  // Wipe
  wipeBtn.addEventListener("click", () => {
    if(!confirm("確定要清空這個網站在你裝置上的所有資料嗎？")) return;
    [KEY_BOOKS, KEY_CATS, KEY_DRAWS, KEY_CONF, KEY_SET].forEach(k => localStorage.removeItem(k));
    currentPick = null;
    pickBox.classList.remove("show");
    showProgress(false);
    alert("已清空。");
    refreshPills();
    renderCats();
  });

  // Init
  (function init(){
    getSettings();
    getCategories();
    refreshPills();
    renderCats();
  })();

})();
</script>
</body>
</html>
